<!-- HTML header for doxygen 1.9.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NASA Astrobee Robot Software: Building a map with Theia</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" href="favicon.png" type="image/png" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="freeflyer.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 70px;">
  <td id="projectlogo"><img alt="Logo" src="astrobee-logo.png" height="100"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NASA Astrobee Robot Software
   &#160;<span id="projectnumber">0.16.0</span>
   </div>
   <div id="projectbrief">Flight software for the Astrobee robot operating inside the International Space Station.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('theia_map.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Building a map with Theia </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Theia (<a href="https://github.com/sweeneychris/TheiaSfM">https://github.com/sweeneychris/TheiaSfM</a>) is a package for global structure-from-motion (SfM). It may be faster and require less user effort than the method used in Astrobee which consists of creating submaps using incremental SfM on sequences of images that overlap with their immediate neighbors, followed by merging the submaps. Theia uses "cascade matching" to handle non-sequential image acquisitions.</p>
<p>The Theia approach was tested on about 700 images acquired at different times and it did well. It is currently studied as an alternative to Astrobee's approach.</p>
<h1><a class="anchor" id="autotoc_md387"></a>
Install Theia's prerequisites</h1>
<p>Fetch and install <code>conda</code> from: </p><pre class="fragment">https://docs.conda.io/projects/conda/en/latest/user-guide/install/linux.html
</pre><p>Restart your shell if it is suggested to do so.</p>
<p>Create and activate the environment: </p><pre class="fragment">conda create -n theia   
conda activate theia
</pre><p>Run the following command to install some packages and GCC 11: </p><pre class="fragment">conda install -c conda-forge cmake                \
  gcc_linux-64==11.1.0 gxx_linux-64==11.1.0       \
  lapack blas eigen==3.3.7 suitesparse rapidjson  \
  glog gflags rocksdb OpenImageIO                 \
  ceres-solver=1.14.0=h0948850_10
</pre><p>The Ceres package can be quite particular about the version of Eigen it uses, and some versions of Ceres are not built with suitesparse which is a sparse solver that is needed for best performance, so some care is needed with choosing the versions of the packages.</p>
<h1><a class="anchor" id="autotoc_md388"></a>
Fetch and build Theia</h1>
<pre class="fragment">git clone git@github.com:sweeneychris/TheiaSfM.git
cd TheiaSfM
git checkout d2112f1 # this version was tested
</pre><p>Edit the file: </p><pre class="fragment">applications/CMakeLists.txt
</pre><p>and comment out all the lines regarding OpenGL, GLEW, GLUT, and view_reconstruction. That visualizer logic is not easy to compile and is not needed.</p>
<p>Run <code>which cmake</code> to ensure its version in the <code>theia</code> environemnt installed earlier is used. Otherwise run again <code>conda activate theia</code>. Do: </p><pre class="fragment">mkdir build
cd build
cmake ..
make -j 20
</pre><p>This will create the executables <code>build_reconstruction</code> and <code>export_to_nvm_file</code> in the <code>bin</code> subdirectory of <code>build</code>. That directory needs to be added to the PATH.</p>
<h1><a class="anchor" id="autotoc_md389"></a>
Run the Astrobee wrapper around the Theia tools</h1>
<p>The conda environment set up earlier will confuse the lookup the dependencies for the Astrobee libraries. Hence the lines <code>conda</code> added to one's <code>.bashrc</code> should be removed, the bash shell restarted, and one should ensure that the <code>env</code> command has no mentions of conda.</p>
<p>Set the environment. The following lines should be adjusted as needed, especially the robot name: </p><pre class="fragment">export ASTROBEE_SOURCE_PATH=$HOME/projects/astrobee/src
source $ASTROBEE_SOURCE_PATH/../devel/setup.bash
export ASTROBEE_RESOURCE_DIR=$ASTROBEE_SOURCE_PATH/astrobee/resources
export ASTROBEE_CONFIG_DIR=$ASTROBEE_SOURCE_PATH/astrobee/config
export ASTROBEE_WORLD=iss
export ASTROBEE_ROBOT=bumble

python $ASTROBEE_SOURCE_PATH/localization/sparse_mapping/tools/build_theia_map.py \
   --output_map theia.map --work_dir theia_work --image_list image_list.txt
</pre><p>This will take care of preparing everything Theia needs, will run it, and will export the resulting map to Astrobee's expected format. This map will need to be registered and visualized as described in other documentation. The work directory can be deleted later.</p>
<p>This tool has the following command-line options: </p><pre class="fragment">--theia_flags: The flags to pass to Theia. If not specified, use
  localization/sparse_mapping/theia_flags.txt in the Astrobee repo.
--image_list: The list of distorted (original) nav cam images to
  use, one per line.
--output_map: The resulting output map.
--skip_rebuilding: Do not rebuild the map after importing it from
  Theia.
--work_dir: A temporary work directory to be deleted by the user
  later.
--keep_undistorted_images: Do not replace the undistorted images
  Theia used with the original distorted ones in the sparse map
  imported from Theia. This is for testing purposes.
--help: Show this help message and exit.
</pre><h1><a class="anchor" id="autotoc_md390"></a>
Auxiliary import_map tool</h1>
<p>This tool is used to import a map from the NVM format, which Theia exports to. These operations are done automatically by the <code>build_theia_map.py</code> tool. This documentation is provided for reference only.</p>
<p>An NVM map exported by Theia (or some other SfM tool) can be saved as an Astrobee sparse map with the command: </p><pre class="fragment">astrobee/devel/lib/sparse_mapping/import_map                             \
  -undistorted_camera_params "wid_x wid_y focal_len opt_ctr_x opt_ctr_y" \
  &lt;undistorted images&gt;                                                   \
  -input_map map.nvm -output_map map.map
</pre><p>This assumes that the images were acquired with the nav camera of the robot given by $ASTROBEE_ROBOT and undistorted with the Astrobee program <code>undistort_image</code>. The undistorted camera parameters to use should be as printed on the screen (and saved to disk) by <code>undistort_image</code>.</p>
<p>If desired to replace on importing the undistorted images with the original distorted ones, as it is usually expected of a sparse map, the above command should be called instead as: </p><pre class="fragment">astrobee/devel/lib/sparse_mapping/import_map \
  -undistorted_images_list undist_list.txt   \
  -distorted_images_list dist_list.txt       \
  -input_map map.nvm -output_map map.map
</pre><p>Here, the files undist_list.txt and dist_list.txt must have one image per line and be in one-to-one correspondence. It is important that both undistorted and distorted images be specified, as the former are needed to look up camera poses and other data in the .nvm file before being replaced with the distorted ones. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.0-->
<!-- start footer part -->
</body>
</html>
